<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">Gujarat Geo-Visualizer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.firebaseTools = { auth, provider, signInWithPopup, onAuthStateChanged, signOut };
    </script>
    <style>
        #map { height: 100vh; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        .control-panel { z-index: 1000; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .loader { border: 6px solid #f3f3f3; border-radius: 50%; border-top: 6px solid #3498db; width: 60px; height: 60px; animation: spin 1.2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 10000; opacity: 0; transition: opacity 0.5s, transform 0.5s; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        .notification.info { background-color: #17a2b8; }
        select:disabled { background-color: #e9ecef; cursor: not-allowed; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 10001; display: none; justify-content: center; align-items: center; }
        /* Toggle Switch Styles */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(22px); }
        /* Animation Styles */
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } }
        @keyframes pulse-orange { 0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } }
        .animate-pulse-red { animation: pulse-red 2s infinite; }
        .animate-pulse-orange { animation: pulse-orange 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="loader-overlay" class="loader-overlay"><div class="loader"></div></div>
    <div id="notification" class="notification"></div>

    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-4" data-lang-key="about_title">About This Application</h2>
            <p class="mb-4" data-lang-key="about_text">This tool provides real-time weather forecasts, heatwave alerts, and historical fire data for Gujarat to help communities stay safe and informed. Select a location from the dropdowns or use your current location to get started.</p>
            <button id="close-about-modal" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-lang-key="close">Close</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="control-panel absolute top-4 left-4 bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-2xl max-w-md w-full space-y-4 transition-all duration-300">
        <!-- Menu -->
        <div class="flex justify-between items-center border-b pb-3">
             <div class="flex items-center gap-4">
                <button id="home-btn" class="font-bold text-blue-600" data-lang-key="home">Home</button>
                <button id="about-btn" class="font-semibold text-gray-600 hover:text-blue-600" data-lang-key="about">About</button>
            </div>
            <select id="language-toggle" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5">
                <option value="en">English</option>
                <option value="gu">ગુજરાતી</option>
            </select>
        </div>
        
        <!-- Auth Section -->
        <div id="auth-section">
            <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 font-bold py-2.5 px-4 rounded-lg shadow-sm transition-transform transform hover:scale-105">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                <span data-lang-key="google_signin">Continue with Google</span>
            </button>
        </div>
        <div id="user-info" class="hidden flex-col gap-3 p-3 bg-green-100 border border-green-300 rounded-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User photo">
                    <p id="user-name" class="text-sm font-semibold text-green-800"></p>
                </div>
                <button id="sign-out-btn" class="text-xs bg-red-500 text-white font-bold py-1 px-2 rounded-md" data-lang-key="sign_out">Sign Out</button>
            </div>
            <div class="flex items-center justify-between pt-2 border-t border-green-200">
                <label for="notification-toggle" class="text-sm font-medium text-gray-700" data-lang-key="heatwave_alerts">Heatwave Alerts</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="notification-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="space-y-4">
            <button id="getLocationBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105" data-lang-key="get_location">Get Data for My Location</button>
            
            <div class="space-y-3 p-3 bg-gray-50 rounded-lg border">
                <p class="font-medium text-gray-600" data-lang-key="filter_location">Filter by Location</p>
                <!-- Dropdowns here -->
                 <div>
                        <label for="district-select" class="block mb-1 text-sm font-medium text-gray-700" data-lang-key="filter_district">District</label>
                        <select id="district-select" class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <option value="" data-lang-key="select_district">Select District</option>
                        </select>
                    </div>
                    <div>
                        <label for="taluka-select" class="block mb-1 text-sm font-medium text-gray-700" data-lang-key="filter_taluka">Taluka</label>
                        <select id="taluka-select" class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" disabled>
                            <option value="" data-lang-key="select_taluka">Select Taluka</option>
                        </select>
                    </div>
                    <div>
                        <label for="gp-select" class="block mb-1 text-sm font-medium text-gray-700" data-lang-key="filter_gp">Gram Panchayat</label>
                        <select id="gp-select" class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" disabled>
                            <option value="" data-lang-key="select_gp">Select Gram Panchayat</option>
                        </select>
                    </div>
            </div>

            <button id="downloadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105" data-lang-key="download_data">Download Displayed Data</button>
        </div>
        
        <!-- Unified Alerts Panel -->
        <div id="alerts-panel" class="hidden p-4 rounded-lg">
            <div class="flex items-center">
                <div id="alert-icon" class="text-5xl mr-4"></div>
                <div>
                    <p id="alert-title" class="font-extrabold text-lg"></p>
                    <p id="alert-message" class="text-base"></p>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div id="info-panel" class="hidden pt-4 border-t">
             <h3 class="text-lg font-semibold mb-2 text-gray-800" id="info-title"></h3>
             <div id="weather-info" class="text-lg space-y-2"></div>
        </div>
    </div>

    <script>
        const JAWG_ACCESS_TOKEN = '';
        const map = L.map('map').setView([22.30, 71.18], 7);
        const UIElements = {
            loader: document.getElementById('loader-overlay'),
            notification: document.getElementById('notification'),
            locationButton: document.getElementById('getLocationBtn'),
            downloadButton: document.getElementById('downloadBtn'),
            districtSelect: document.getElementById('district-select'),
            talukaSelect: document.getElementById('taluka-select'),
            gpSelect: document.getElementById('gp-select'),
            infoPanel: document.getElementById('info-panel'),
            infoTitle: document.getElementById('info-title'),
            weatherInfoDiv: document.getElementById('weather-info'),
            languageToggle: document.getElementById('language-toggle'),
            googleSignInBtn: document.getElementById('google-signin-btn'),
            authSection: document.getElementById('auth-section'),
            userInfo: document.getElementById('user-info'),
            userName: document.getElementById('user-name'),
            userPhoto: document.getElementById('user-photo'),
            signOutBtn: document.getElementById('sign-out-btn'),
            alertsPanel: document.getElementById('alerts-panel'),
            alertIcon: document.getElementById('alert-icon'),
            alertTitle: document.getElementById('alert-title'),
            alertMessage: document.getElementById('alert-message'),
            aboutModal: document.getElementById('about-modal'),
            closeAboutModalBtn: document.getElementById('close-about-modal'),
            aboutBtn: document.getElementById('about-btn'),
            notificationToggle: document.getElementById('notification-toggle'),
        };

        let isRequestCoolingDown = false;
        let locationData = [];
        let fireData = [];
        let displayedDataForCSV = [];
        let notificationInterval = null;
        const layerGroups = { fire: L.layerGroup().addTo(map), weather: L.layerGroup().addTo(map) };

        const translations = {
            en: {
                title: "Gujarat Geo-Visualizer", header: "Gujarat Geo-Visualizer", language: "Language", controls_title: "Analysis & Controls",
                home: "Home", about: "About", close: "Close", sign_out: "Sign Out", heatwave_alerts: "Heatwave Alerts",
                about_title: "About This Application", about_text: "This tool provides real-time weather forecasts, heatwave alerts, and historical fire data for Gujarat to help communities stay safe and informed. Select a location from the dropdowns or use your current location to get started.",
                get_location: "Get Data for My Location", filter_location: "Filter by Location", filter_district: "District",
                select_district: "Select District", filter_taluka: "Taluka", select_taluka: "Select Taluka", filter_gp: "Gram Panchayat",
                select_gp: "Select Gram Panchayat", download_data: "Download Displayed Data", location_weather_title: "Weather at Your Location",
                weather_title: "Weather for {name}", max_temp: "Max Temp", min_temp: "Min Temp", current_temp: "Current Temp", humidity: "Humidity",
                wind_speed: "Wind Speed", description: "Condition", fire_confidence: "Fire Confidence", google_signin: "Continue with Google",
                heatwave_warning_title: "Heatwave Warning", heatwave_warning_message: "High temperatures expected. Stay hydrated!",
                fire_warning_title: "Recent Fire Activity", fire_warning_message: "{count} fire incidents reported in the last 7 days.",
                all_clear_title: "All Clear", all_clear_message: "No immediate fire or heatwave threats.",
                notification_heatwave_title: "Heatwave Alert!", notification_heatwave_body: "High temperatures expected today. Max temp: {temp}°C. Stay hydrated and avoid sun exposure.",
                data_saved_success: "Data saved to CSV file.", no_data_to_save: "No data to save.",
                location_fetch_error: "Could not get your location.", weather_fetch_error: "Could not get weather data.",
                fire_data_fetch_error: "Could not load fire data file. Make sure 'gujarat_fire_history.csv' exists.", fire_data_loaded: "Historical fire data loaded.",
                cooldown_active: "Please wait before trying again.", csv_load_error: "Failed to load location data file.",
                coords_not_found: "Coordinates not found.",
            },
            gu: {
                title: "ગુજરાત જીઓ-વિઝ્યુઅલાઈઝર", header: "ગુજરાત જીઓ-વિઝ્યુઅલાઈઝર", language: "ભાષા", controls_title: "વિશ્લેષણ અને નિયંત્રણો",
                home: "હોમ", about: "વિશે", close: "બંધ કરો", sign_out: "સાઇન આઉટ", heatwave_alerts: "હીટવેવ ચેતવણીઓ",
                about_title: "આ એપ્લિકેશન વિશે", about_text: "આ સાધન સમુદાયોને સુરક્ષિત અને માહિતગાર રહેવામાં મદદ કરવા માટે ગુજરાત માટે વાસ્તવિક-સમયની હવામાનની આગાહી, હીટવેવ ચેતવણીઓ અને ઐતિહાસિક આગનો ડેટા પ્રદાન કરે છે. શરૂ કરવા માટે ડ્રોપડાઉનમાંથી કોઈ સ્થાન પસંદ કરો અથવા તમારા વર્તમાન સ્થાનનો ઉપયોગ કરો.",
                get_location: "મારા સ્થાન માટે ડેટા મેળવો", filter_location: "સ્થાન દ્વારા ફિલ્ટર કરો", filter_district: "જિલ્લો",
                select_district: "જિલ્લો પસંદ કરો", filter_taluka: "તાલુકો", select_taluka: "તાલુકો પસંદ કરો", filter_gp: "ગ્રામ પંચાયત",
                select_gp: "ગ્રામ પંચાયત પસંદ કરો", download_data: "પ્રદર્શિત ડેટા ડાઉનલોડ કરો", location_weather_title: "તમારા સ્થાન પર હવામાન",
                weather_title: "{name} માટે હવામાન", max_temp: "મહત્તમ તાપમાન", min_temp: "ન્યૂનતમ તાપમાન", current_temp: "વર્તમાન તાપમાન",
                humidity: "ભેજ", wind_speed: "પવનની ગતિ", description: "સ્થિતિ", fire_confidence: "આગની સંભાવના", google_signin: "Google વડે ચાલુ રાખો",
                heatwave_warning_title: "હીટવેવ ચેતવણી", heatwave_warning_message: "ઊંચા તાપમાનની અપેક્ષા છે. હાઇડ્રેટેડ રહો!",
                fire_warning_title: "તાજેતરની આગની પ્રવૃત્તિ", fire_warning_message: "છેલ્લા 7 દિવસમાં {count} આગની ઘટનાઓ નોંધાઈ છે.",
                all_clear_title: "બધું બરાબર છે", all_clear_message: "કોઈ તાત્કાલિક આગ કે હીટવેવનો ખતરો નથી.",
                notification_heatwave_title: "હીટવેવ ચેતવણી!", notification_heatwave_body: "આજે ઊંચા તાપમાનની અપેક્ષા છે. મહત્તમ તાપમાન: {temp}°C. હાઇડ્રેટેડ રહો અને તડકામાં જવાનું ટાળો.",
                data_saved_success: "ડેટા CSV ફાઇલમાં સાચવવામાં આવ્યો.", no_data_to_save: "સાચવવા માટે કોઈ ડેટા નથી.",
                location_fetch_error: "તમારું સ્થાન મેળવી શકાયું નથી.", weather_fetch_error: "હવામાન ડેટા મેળવી શકાયો નથી.",
                fire_data_fetch_error: "આગ ડેટા ફાઇલ લોડ કરી શકાઈ નથી. ખાતરી કરો કે 'gujarat_fire_history.csv' અસ્તિત્વમાં છે.", fire_data_loaded: "ઐતિહાસિક આગનો ડેટા લોડ થયો.",
                cooldown_active: "કૃપા કરીને ફરી પ્રયાસ કરતા પહેલા રાહ જુઓ.", csv_load_error: "સ્થાન ડેટા ફાઇલ લોડ કરવામાં નિષ્ફળ.",
                coords_not_found: "કોઓર્ડિનેટ્સ મળ્યા નથી.",
            }
        };

        const toggleLoader = (show) => { UIElements.loader.style.display = show ? 'flex' : 'none'; };
        const showNotification = (key, type = 'info', duration = 4000) => {
            const lang = UIElements.languageToggle.value;
            const message = translations[lang][key] || key;
            UIElements.notification.textContent = message;
            UIElements.notification.className = `notification show ${type}`;
            setTimeout(() => { UIElements.notification.className = 'notification'; }, duration);
        };
        const updateLanguage = () => {
            const lang = UIElements.languageToggle.value;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang]?.[key]) el.innerHTML = translations[lang][key];
            });
            updateAlertsPanel(); // Re-render alerts panel with new language
        };

        const initMap = () => {
            L.tileLayer('https://{s}.tile.jawg.io/jawg-streets/{z}/{x}/{y}{r}.png?access-token={accessToken}', {
                attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                minZoom: 6, maxZoom: 22, accessToken: JAWG_ACCESS_TOKEN
            }).addTo(map);
        };

        async function loadLocalCSV(filePath, errorKey) {
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`Network response not ok for ${filePath}`);
                const csvText = await response.text();
                return new Promise(resolve => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data)
                    });
                });
            } catch (error) {
                console.error(`Error loading ${filePath}:`, error);
                showNotification(errorKey, 'error');
                return [];
            }
        }

        async function initializeData() {
            toggleLoader(true);
            locationData = await loadLocalCSV('merged_village_temperature_data.csv', 'csv_load_error');
            if (locationData.length > 0) {
                const districts = [...new Set(locationData.map(item => item['District Name']))].filter(Boolean).sort();
                populateDropdown(UIElements.districtSelect, districts, 'select_district');
            }
            fireData = await loadLocalCSV('gujarat_fire_history.csv', 'fire_data_fetch_error');
            if (fireData.length > 0) {
                displayFireData(fireData);
                showNotification('fire_data_loaded', 'success');
            }
            updateAlertsPanel(); // Initial alert check
            toggleLoader(false);
        }

        function updateAlertsPanel(isHeatwave = false) {
            const lang = UIElements.languageToggle.value;
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentFires = fireData.filter(fire => new Date(fire.acq_date) >= sevenDaysAgo);

            UIElements.alertsPanel.classList.remove('bg-red-100', 'border-red-500', 'animate-pulse-red', 'bg-orange-100', 'border-orange-500', 'animate-pulse-orange', 'bg-green-100', 'border-green-500');
            UIElements.alertsPanel.classList.add('hidden');

            if (recentFires.length > 0) {
                UIElements.alertIcon.textContent = '🔥';
                UIElements.alertTitle.textContent = translations[lang].fire_warning_title;
                UIElements.alertMessage.textContent = translations[lang].fire_warning_message.replace('{count}', recentFires.length);
                UIElements.alertsPanel.classList.add('bg-red-100', 'border-red-500', 'animate-pulse-red');
                UIElements.alertsPanel.classList.remove('hidden');
            } else if (isHeatwave) {
                UIElements.alertIcon.textContent = '☀️';
                UIElements.alertTitle.textContent = translations[lang].heatwave_warning_title;
                UIElements.alertMessage.textContent = translations[lang].heatwave_warning_message;
                UIElements.alertsPanel.classList.add('bg-orange-100', 'border-orange-500', 'animate-pulse-orange');
                UIElements.alertsPanel.classList.remove('hidden');
            } else {
                UIElements.alertIcon.textContent = '✅';
                UIElements.alertTitle.textContent = translations[lang].all_clear_title;
                UIElements.alertMessage.textContent = translations[lang].all_clear_message;
                UIElements.alertsPanel.classList.add('bg-green-100', 'border-green-500');
                UIElements.alertsPanel.classList.remove('hidden');
            }
        }

        function displayFireData(fires) {
            layerGroups.fire.clearLayers();
            const lang = UIElements.languageToggle.value;
            fires.forEach(fire => {
                const lat = parseFloat(fire.latitude);
                const lon = parseFloat(fire.longitude);
                const fireIcon = L.divIcon({ html: '🔥', className: 'text-2xl', iconSize: [24, 24] });
                L.marker([lat, lon], { icon: fireIcon })
                    .addTo(layerGroups.fire)
                    .bindPopup(`<b>${translations[lang].fire_confidence}: ${fire.confidence}%</b><br>Date: ${fire.acq_date}`);
            });
        }
        
        const getWeatherDescription = (code) => ({0:'Clear',1:'Mainly Clear',2:'Partly Cloudy',3:'Overcast',45:'Fog',48:'Rime Fog',51:'Light Drizzle',53:'Drizzle',55:'Dense Drizzle',61:'Slight Rain',63:'Rain',65:'Heavy Rain',71:'Slight Snow',73:'Snow',75:'Heavy Snow',80:'Rain Showers',81:'Showers',82:'Violent Showers',95:'Thunderstorm',96:'Thunderstorm+Hail',99:'Heavy Thunderstorm'}[code]||'Unknown');

        function displayWeatherData(data, locationName) {
            layerGroups.weather.clearLayers();
            const lang = UIElements.languageToggle.value;
            const currentTemp = data.current.temperature_2m;
            const maxTemp = data.daily.temperature_2m_max[0];
            const humidity = data.current.relative_humidity_2m;
            const windSpeed = data.current.wind_speed_10m;
            const description = getWeatherDescription(data.current.weather_code);
            const isHeatwave = maxTemp >= 40;

            updateAlertsPanel(isHeatwave); // Update alerts based on weather

            UIElements.infoPanel.classList.remove('hidden');
            UIElements.infoTitle.textContent = translations[lang].weather_title.replace('{name}', locationName);
            UIElements.weatherInfoDiv.innerHTML = `
                <p><strong>${translations[lang].max_temp}:</strong> ${maxTemp}°C</p>
                <p><strong>${translations[lang].current_temp}:</strong> ${currentTemp}°C</p>
                <p><strong>${translations[lang].humidity}:</strong> ${humidity}%</p>
                <p><strong>${translations[lang].wind_speed}:</strong> ${windSpeed} km/h</p>
                <p><strong>${translations[lang].description}:</strong> ${description}</p>`;
            
            L.marker([data.latitude, data.longitude]).addTo(layerGroups.weather);
            if (isHeatwave) {
                const heatwaveIcon = L.divIcon({ html: '☀️', className: 'text-4xl animate-pulse', iconSize: [40, 40] });
                L.marker([data.latitude, data.longitude], { icon: heatwaveIcon }).addTo(layerGroups.weather);
            }
            
            displayedDataForCSV.push({
                type: 'Weather Forecast', location: locationName, latitude: data.latitude, longitude: data.longitude,
                max_temp_c: maxTemp, current_temp_c: currentTemp, humidity_percent: humidity, 
                wind_speed_kmh: windSpeed, description: description, heatwave_warning: isHeatwave,
            });
        }

        async function fetchWeatherForNotification() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max&timezone=auto`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    const maxTemp = data.daily.temperature_2m_max[0];
                    if (maxTemp >= 40) {
                        const lang = UIElements.languageToggle.value;
                        const title = translations[lang].notification_heatwave_title;
                        const body = translations[lang].notification_heatwave_body.replace('{temp}', maxTemp);
                        new Notification(title, { body: body });
                    }
                } catch (error) {
                    console.error("Background weather check failed:", error);
                }
            });
        }

        async function fetchAndDisplayWeather(lat, lon, name) {
            toggleLoader(true);
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max&timezone=auto`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Weather data not found');
                const data = await response.json();
                displayWeatherData(data, name);
            } catch (error) {
                showNotification('weather_fetch_error', 'error');
            } finally {
                toggleLoader(false);
            }
        }

        function handleGetLocation() {
            if (isRequestCoolingDown) return showNotification('cooldown_active', 'info');
            if (navigator.geolocation) {
                toggleLoader(true);
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13);
                    const lang = UIElements.languageToggle.value;
                    fetchAndDisplayWeather(latitude, longitude, translations[lang].location_weather_title);
                    isRequestCoolingDown = true;
                    setTimeout(() => { isRequestCoolingDown = false; }, 5000);
                }, () => {
                    toggleLoader(false);
                    showNotification('location_fetch_error', 'error');
                });
            }
        }

        function handleDownloadData() {
            if (displayedDataForCSV.length === 0) return showNotification('no_data_to_save', 'info');
            const csv = Papa.unparse(displayedDataForCSV);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'gujarat_geodata_export.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('data_saved_success', 'success');
        }

        function populateDropdown(selectElement, items, defaultOptionKey) {
            const lang = UIElements.languageToggle.value;
            selectElement.innerHTML = `<option value="">${translations[lang][defaultOptionKey]}</option>`;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        }

        function resetDropdown(selectElement, defaultOptionKey) {
            const lang = UIElements.languageToggle.value;
            selectElement.innerHTML = `<option value="">${translations[lang][defaultOptionKey]}</option>`;
            selectElement.disabled = true;
        }
        
        function setupAuth() {
            const { auth, provider, signInWithPopup, onAuthStateChanged, signOut } = window.firebaseTools;
            
            UIElements.googleSignInBtn.addEventListener('click', () => {
                signInWithPopup(auth, provider).catch((error) => console.error("Google Sign-In Error:", error));
            });

            UIElements.signOutBtn.addEventListener('click', () => {
                signOut(auth).catch(error => console.error("Sign Out Error", error));
            });

            onAuthStateChanged(auth, user => {
                if (user) {
                    UIElements.authSection.classList.add('hidden');
                    UIElements.userInfo.classList.remove('hidden');
                    UIElements.userInfo.classList.add('flex');
                    UIElements.userName.textContent = user.displayName;
                    UIElements.userPhoto.src = user.photoURL;
                } else {
                    UIElements.authSection.classList.remove('hidden');
                    UIElements.userInfo.classList.add('hidden');
                    UIElements.userInfo.classList.remove('flex');
                    if (notificationInterval) clearInterval(notificationInterval);
                    UIElements.notificationToggle.checked = false;
                }
            });
        }

        function setupNotificationToggle() {
            UIElements.notificationToggle.addEventListener('change', () => {
                if (UIElements.notificationToggle.checked) {
                    if (Notification.permission === 'granted') {
                        fetchWeatherForNotification();
                        notificationInterval = setInterval(fetchWeatherForNotification, 3 * 60 * 60 * 1000);
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                fetchWeatherForNotification();
                                notificationInterval = setInterval(fetchWeatherForNotification, 3 * 60 * 60 * 1000);
                            } else {
                                UIElements.notificationToggle.checked = false;
                            }
                        });
                    } else {
                        alert("You have blocked notifications. Please enable them in your browser settings to receive alerts.");
                        UIElements.notificationToggle.checked = false;
                    }
                } else {
                    if (notificationInterval) clearInterval(notificationInterval);
                }
            });
        }

        UIElements.districtSelect.addEventListener('change', () => {
            const selectedDistrict = UIElements.districtSelect.value;
            resetDropdown(UIElements.gpSelect, 'select_gp');
            if (selectedDistrict) {
                const talukas = [...new Set(locationData.filter(d => d['District Name'] === selectedDistrict).map(item => item['Taluka Name']))].filter(Boolean).sort();
                populateDropdown(UIElements.talukaSelect, talukas, 'select_taluka');
            } else {
                resetDropdown(UIElements.talukaSelect, 'select_taluka');
            }
        });

        UIElements.talukaSelect.addEventListener('change', () => {
            const selectedDistrict = UIElements.districtSelect.value;
            const selectedTaluka = UIElements.talukaSelect.value;
            if (selectedDistrict && selectedTaluka) {
                const gps = [...new Set(locationData.filter(d => d['District Name'] === selectedDistrict && d['Taluka Name'] === selectedTaluka).map(item => item['Gram Panchayat']))].filter(Boolean).sort();
                populateDropdown(UIElements.gpSelect, gps, 'select_gp');
            } else {
                resetDropdown(UIElements.gpSelect, 'select_gp');
            }
        });

        UIElements.gpSelect.addEventListener('change', () => {
            const selectedDistrict = UIElements.districtSelect.value;
            const selectedTaluka = UIElements.talukaSelect.value;
            const selectedGP = UIElements.gpSelect.value;

            if (selectedDistrict && selectedTaluka && selectedGP) {
                const location = locationData.find(d => d['District Name'] === selectedDistrict && d['Taluka Name'] === selectedTaluka && d['Gram Panchayat'] === selectedGP);
                if (location) {
                    const lat = parseFloat(location['Taluka Latitude']) || parseFloat(location['District Latitude']);
                    const lon = parseFloat(location['Taluka Longitude']) || parseFloat(location['District Longitude']);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        map.setView([lat, lon], 12);
                        fetchAndDisplayWeather(lat, lon, `${selectedGP}, ${selectedTaluka}`);
                    } else {
                        showNotification('coords_not_found', 'error');
                    }
                }
            }
        });

        UIElements.aboutBtn.addEventListener('click', () => UIElements.aboutModal.style.display = 'flex');
        UIElements.closeAboutModalBtn.addEventListener('click', () => UIElements.aboutModal.style.display = 'none');

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initializeData();
            updateLanguage();
            setupAuth();
            setupNotificationToggle();
            UIElements.locationButton.addEventListener('click', handleGetLocation);
            UIElements.downloadButton.addEventListener('click', handleDownloadData);
            UIElements.languageToggle.addEventListener('change', updateLanguage);
        });
    </script>
</body>
</html>
